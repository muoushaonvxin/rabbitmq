
## 集群搭建

<br/>

前面一些记录都是如何使用rabbitmq的记录, 不过这些都是单机版的, 无法满足目前真实应用的要求. 试想一下, 如果rabbitmq服务器遇到内存崩溃, 机器掉电或者主板故障灯情况, 该怎么办? 单台rabbitmq服务器可以满足每秒1000条消息的吞吐量, 那么如果应用需要rabbitmq服务满足每秒10万条消息的吞吐量呢? 购买昂贵的服务器来增强单机rabbitmq服务的性能显得捉襟见肘, 搭建一个rabbitmq集群才是解决实际问题的关键.

rabbitmq集群允许消费者和生产者在rabbitmq单个节点崩溃的情况下继续运行, 它可以通过添加更多的节点来线性地扩展消息通信的吞吐量. 当失去一个rabbitmq节点时, 客户端能够重新连接到集群中的任何其他节点并继续生产或者消费.

不过rabbitmq集群不能保证消息的万无一失, 即将消息, 队列, 交换器等都设置为可持久化, 生产端和消费端都正确地使用了确认方式. 当集群中一个rabbitmq节点崩溃时, 该节点上的所有队列中的消息也会丢失. rabbitmq集群中的所有节点都会被备份所有的元数据信息

内容如下:
1) 队列元数据: 队列的名称及属性
2) 交换器: 交换器的名称及属性
3) 绑定关系元数据: 交换器与队列或者交换器与交换器之间的绑定关系
4) vhost 元数据: 为vhost内的队列, 交换器和绑定提供命名空间及安全属性

## 多机多节点配置

<br/>

多机多节点主要是指在每台机器中部署一个rabbitmq服务节点, 进而由多台机器组成rabbitmq集群

假设在这里一共有三台物理主机, 均已正确地安装了rabbitmq, 且主机名分别为 node1, node2, node3. rabbitmq集群对延迟非常敏感, 应当只在本地局域网内使用. 在广域网中不应该使用集群, 而应该使用Federation或者Shovel来代替.

接下来需要按照以下步骤执行.第一步, 配置各个节点的host文件, 让各个节点都能互相识别对方的存在. 比如在Linux系统中可以编辑 /etc/hosts文件, 在其中添加ip地址与节点名称的映射信息:
```shell
192.168.0.1    node1
192.168.0.2    node2
192.168.0.3    node3
```

第二步, 编辑rabbitmq的cookie文件, 以确保各个节点的cookie文件使用的是同一个值. 可以读取node1节点的cookie值, 然后将其复制到node2和node3节点中. cookie文件默认路径为 /var/lib/rabbitmq/.erlang.cookie 或者 $HOME/.erlang.cookie, cookie相当于密钥令牌, 集群中的rabbitmq节点需要通过交换密钥令牌以获得相互认证. 如果节点的密钥令牌不一致, 那么在配置节点时就会有如下的报错.

```shell
[root@node2 ~]# rabbitmqctl join_cluster rabbit@node1
Clustering node rabbit@node2 with rabbit@node1
Error: unable to connect to nodes [rabbit@node1]: nodedown

DIAGNOSTICS
===========

attempted to contact: [rabbit@node1]

rabbit@node1:
* connected to epmd (port 4369) on node1
* epmd reports node 'rabbit' running on port 25672
* TCP connection succeeded but Erlang distribution failed

* Authentication failed (rejected by the remote node), please check the Erlang cookie

current node details:
- node name: 'rabbitmq-cli-53@node1'
- home dir: /root
- cookie hash: kLtTY75JJGZnZpQF7CqnYg==
```

## 集群管理

<br/>

| 执行命令 | 产生作用 |
|----------|---------|
| rabbitmqctl join_cluster {cluster_node} [--ram] | 将指定节点加入集群中, 命令执行前需要停止rabbtimq应用并重置节点 |
| rabbitmqctl cluster_status | 显示集群的状态 |
| rabbitmqctl change_cluster_node_type [disc, ram} | 修改集群节点的类型, 命令执行前需要停止rabbitmq应用 |
| rabbitmqctl forget_cluster_node [--offline] | 将节点从集群中删除 |
| rabbitmqctl update_cluster_nodes {clusternode} | 更新节点信息 |

